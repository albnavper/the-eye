# Process Config Issue Workflow
# Parses JSON from issue body and creates a PR to update sites.json

name: Process Config Issue

on:
  issues:
    types: [opened, edited]

jobs:
  process:
    if: contains(github.event.issue.labels.*.name, 'config-update')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Extract and validate JSON
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue.body;
            
            // Extract JSON from code block
            const jsonMatch = issueBody.match(/```json\s*([\s\S]*?)\s*```/);
            if (!jsonMatch) {
              core.setFailed('No JSON code block found in issue body');
              return;
            }
            
            const jsonStr = jsonMatch[1].trim();
            
            // Validate JSON
            let config;
            try {
              config = JSON.parse(jsonStr);
            } catch (e) {
              core.setFailed(`Invalid JSON: ${e.message}`);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `❌ **Error parsing JSON**: ${e.message}\n\nPlease fix the JSON and edit the issue.`
              });
              return;
            }
            
            // Basic schema validation
            if (!config.sites || !Array.isArray(config.sites)) {
              core.setFailed('JSON must have a "sites" array');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '❌ **Schema error**: JSON must have a "sites" array at the root level.'
              });
              return;
            }
            
            // Validate each site
            for (const site of config.sites) {
              if (!site.id || !site.name || !site.url || !site.extraction) {
                core.setFailed(`Site missing required fields: ${JSON.stringify(site)}`);
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: `❌ **Schema error**: Each site must have: id, name, url, extraction\n\nProblematic site: \`${site.id || site.name || 'unknown'}\``
                });
                return;
              }
            }
            
            // Write validated config
            const fs = require('fs');
            fs.writeFileSync('config/sites.json', JSON.stringify(config, null, 2));
            
            core.setOutput('site_count', config.sites.length);
            core.setOutput('site_names', config.sites.map(s => s.name).join(', '));
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'config: Update sites.json from issue #${{ github.event.issue.number }}'
          branch: config-update-${{ github.event.issue.number }}
          delete-branch: true
          title: 'Config Update: ${{ github.event.issue.title }}'
          body: |
            This PR updates `config/sites.json` based on issue #${{ github.event.issue.number }}.
            
            **Sites**: ${{ steps.extract.outputs.site_names }}
            **Total sites**: ${{ steps.extract.outputs.site_count }}
            
            ---
            
            Closes #${{ github.event.issue.number }}
          labels: config-update
      
      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `✅ **JSON validated successfully!**\n\nA pull request has been created to update the configuration. Please review and merge it.\n\n**Sites found**: ${{ steps.extract.outputs.site_count }}`
            });
